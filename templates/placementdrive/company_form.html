{% extends "base.html" %}
{% block title %}{% if form.instance.pk %}Edit Company{% else %}Add Company{% endif %}{% endblock %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/student_form_modern.css' %}">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .select2-container {
        width: 100% !important;
    }
    .select2-container--default .select2-selection--multiple{
        border: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="student-form-container">
    <div class="form-header">
        <h1>{% if form.instance.pk %}Edit Company{% else %}Add Company{% endif %}</h1>
    </div>

    <form method="post" class="student-form">
        {% csrf_token %}
        <div class="form-section-card">
            <div class="form-section-header">
                <h5 style="color: white;"><i class="fas fa-building me-2" style="color: white;"></i>Company Details</h5>
            </div>
            <div class="form-section-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.portal.label_tag }}
                            {{ form.portal }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.company_name.label_tag }}
                            {{ form.company_name }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.spoc.label_tag }}
                            {{ form.spoc }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.mobile.label_tag }}
                            {{ form.mobile }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.email.label_tag }}
                            {{ form.email }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.location.label_tag }}
                            {{ form.location }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section-card">
            <div class="form-section-header">
                <h5 style="color: white;"><i class="fas fa-briefcase me-2" style="color: white;"></i>Applying Roles</h5>
            </div>
            <div class="form-section-body">
                {{ formset.management_form }}
                <div id="role-forms-container">
                    {% for form in formset %}
                    <div class="role-form mb-3 p-3 border rounded">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.role_name.label_tag }}
                                    {{ form.role_name }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.salary.label_tag }}
                                    {{ form.salary }}
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            {{ form.courses.label_tag }}
                            {{ form.courses }}
                        </div>
                        {% if form.instance.pk %}
                            {{ form.DELETE.label_tag }}
                            {{ form.DELETE }}
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                <button type="button" id="add-role-btn" class="btn btn-secondary mt-2">Add Role</button>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Company</button>
        </div>
    </form>
</div>

<template id="role-form-template">
    <div class="role-form mb-3 p-3 border rounded">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    {{ formset.empty_form.role_name.label_tag }}
                    {{ formset.empty_form.role_name }}
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    {{ formset.empty_form.salary.label_tag }}
                    {{ formset.empty_form.salary }}
                </div>
            </div>
        </div>
        <div class="form-group">
            {{ formset.empty_form.courses.label_tag }}
            {{ formset.empty_form.courses }}
        </div>
        <button type="button" class="btn btn-danger remove-role-btn">Remove</button>
    </div>
</template>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    function initializeSelect2(element) {
        $(element).find('.select2-hidden-accessible').each(function() {
            $(this).select2('destroy');
        });
        $(element).find('select[multiple]').select2();
    }

    $('#role-forms-container').find('.role-form').each(function() {
        initializeSelect2(this);
    });

    $('#add-role-btn').click(function() {
        const template = $('#role-form-template').html();
        const totalForms = $('#id_roles-TOTAL_FORMS');
        const formIdx = parseInt(totalForms.val());
        const newForm = template.replace(/__prefix__/g, formIdx);
        
        $('#role-forms-container').append(newForm);
        totalForms.val(formIdx + 1);

        const newFormElement = $('#role-forms-container').children().last();
        initializeSelect2(newFormElement);
    });

    $('#role-forms-container').on('click', '.remove-role-btn', function() {
        $(this).closest('.role-form').remove();
    });
});
</script>
{% endblock %}