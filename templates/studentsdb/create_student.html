{% extends "base.html" %}
{% block title %}Create Student{% endblock %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/student_form.css' %}">
{% endblock %}

{% block content %}
<div class="student-form-container">
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                {% if 'student_message' in message.tags %}
                    <div class="alert alert-{{ message.level_tag }} alert-dismissible fade show" role="alert">
                        <i class="fas {% if message.level_tag == 'success' %}fa-check-circle{% elif message.level_tag == 'error' %}fa-times-circle{% elif message.level_tag == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %}"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="student-form">
        {% csrf_token %}

        <div class="form-section-card">
            <div class="form-section-header">
                <h5><i class="fas fa-user me-2"></i>Student Personal Details</h5>
            </div>
            <div class="form-section-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.first_name.label_tag }}
                            {{ student_form.first_name }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.last_name.label_tag }}
                            {{ student_form.last_name }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.phone.label_tag }}
                            {{ student_form.phone }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.alternative_phone.label_tag }}
                            {{ student_form.alternative_phone }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.email.label_tag }}
                            {{ student_form.email }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_district">District</label>
                            <select id="id_district" class="form-control"></select>
                        </div>
                        <div class="form-group" id="chennai_area_group" style="display: none;">
                            <label for="id_chennai_area">Area in Chennai</label>
                            <select id="id_chennai_area" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            {{ student_form.location }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section-card">
            <div class="form-section-header">
                <h5><i class="fas fa-graduation-cap me-2"></i>Education Details</h5>
            </div>
            <div class="form-section-body">
                <div class="form-section-subtitle">Undergraduate</div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.ugdegree.label_tag }}
                            {{ student_form.ugdegree }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.ugbranch.label_tag }}
                            {{ student_form.ugbranch }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.ugpassout.label_tag }}
                            {{ student_form.ugpassout }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.ugpercentage.label_tag }}
                            {{ student_form.ugpercentage }}
                        </div>
                    </div>
                </div>

                <div class="form-section-divider"></div>

                <div class="form-section-subtitle">Postgraduate</div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.pgdegree.label_tag }}
                            {{ student_form.pgdegree }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.pgbranch.label_tag }}
                            {{ student_form.pgbranch }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.pgpassout.label_tag }}
                            {{ student_form.pgpassout }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.pgpercentage.label_tag }}
                            {{ student_form.pgpercentage }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section-card">
            <div class="form-section-header">
                <h5><i class="fas fa-book me-2"></i>Course Details</h5>
            </div>
            <div class="form-section-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.course_category.label_tag }}
                            {{ student_form.course_category }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.course.label_tag }}
                            {{ student_form.course }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.start_date.label_tag }}
                            {{ student_form.start_date }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.end_date.label_tag }}
                            {{ student_form.end_date }}
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.mode_of_class.label_tag }}
                            {{ student_form.mode_of_class }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.week_type.label_tag }}
                            {{ student_form.week_type }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.working_status.label_tag }}
                            {{ student_form.working_status }}
                        </div>
                    </div>
                    <div class="col-md-6" id="it_experience_group" style="display: none;">
                        <div class="form-group">
                            {{ student_form.it_experience.label_tag }}
                            {{ student_form.it_experience }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.pl_required.label_tag }}
                            {{ student_form.pl_required }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.source_of_joining.label_tag }}
                            {{ student_form.source_of_joining }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.consultant.label_tag }}
                            {{ student_form.consultant }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.enrollment_date.label_tag }}
                            {{ student_form.enrollment_date }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ student_form.course_status.label_tag }}
                            {{ student_form.course_status }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section-card">
            <div class="form-section-header">
                <h5><i class="fas fa-money-bill me-2"></i>Payment Details</h5>
            </div>
            <div class="form-section-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ payment_form.payment_account.label_tag }}
                            {{ payment_form.payment_account }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ payment_form.total_fees.label_tag }}
                            {{ payment_form.total_fees }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ payment_form.amount_paid.label_tag }}
                            {{ payment_form.amount_paid }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ payment_form.initial_payment_proof.label_tag }}
                            {{ payment_form.initial_payment_proof }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ payment_form.gst_bill.label_tag }}
                            {{ payment_form.gst_bill }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ payment_form.emi_type.label_tag }}
                            {{ payment_form.emi_type }}
                        </div>
                    </div>
                </div>

                <div class="form-section-divider"></div>

                <div class="form-section-subtitle">EMI Details</div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group emi-field" id="emi_1_amount_group">
                            {{ payment_form.emi_1_amount.label_tag }}
                            {{ payment_form.emi_1_amount }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group emi-field" id="emi_1_date_group">
                            {{ payment_form.emi_1_date.label_tag }}
                            {{ payment_form.emi_1_date }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group emi-field" id="emi_2_amount_group">
                            {{ payment_form.emi_2_amount.label_tag }}
                            {{ payment_form.emi_2_amount }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group emi-field" id="emi_2_date_group">
                            {{ payment_form.emi_2_date.label_tag }}
                            {{ payment_form.emi_2_date }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group emi-field" id="emi_3_amount_group">
                            {{ payment_form.emi_3_amount.label_tag }}
                            {{ payment_form.emi_3_amount }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group emi-field" id="emi_3_date_group">
                            {{ payment_form.emi_3_date.label_tag }}
                            {{ payment_form.emi_3_date }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group emi-field" id="emi_4_amount_group">
                            {{ payment_form.emi_4_amount.label_tag }}
                            {{ payment_form.emi_4_amount }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group emi-field" id="emi_4_date_group">
                            {{ payment_form.emi_4_date.label_tag }}
                            {{ payment_form.emi_4_date }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" id="submit-button" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>Save Student
            </button>
            <a href="{% url 'student_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Student List
            </a>
            <span id="emi-error-message" class="error-message" style="display: none;"></span>
        </div>
    </form>
</div>

{% block extra_js %}
<script>
$(document).ready(function () {
    // Initialize Select2 on all select elements first
    $('select').select2({
        width: '100%' // Ensures the dropdowns are responsive
    });

    // Location script
    const locationInput = $('#id_location');
    if (locationInput.length) {
        locationInput.hide();
    }

    const $districtSelect = $('#id_district');
    const $chennaiAreaGroup = $('#chennai_area_group');
    const $chennaiAreaSelect = $('#id_chennai_area');

    // Populate districts if not already populated
    if ($districtSelect.find('option').length <= 1) {
        const districts = ["", "Ariyalur", "Chengalpattu", "Chennai", "Coimbatore", "Cuddalore", "Dharmapuri", "Dindigul", "Erode", "Kallakurichi", "Kanchipuram", "Kanyakumari", "Karur", "Krishnagiri", "Madurai", "Mayiladuthurai", "Nagapattinam", "Namakkal", "Nilgiris", "Perambalur", "Pudukkottai", "Ramanathapuram", "Ranipet", "Salem", "Sivaganga", "Tenkasi", "Thanjavur", "Theni", "Thoothukudi", "Tiruchirappalli", "Tirunelveli", "Tirupathur", "Tiruppur", "Tiruvallur", "Tiruvannamalai", "Tiruvarur", "Vellore", "Viluppuram", "Virudhunagar"];
        districts.forEach(d => {
            $districtSelect.append(new Option(d, d));
        });
    }

    // Populate Chennai areas if not already populated
    if ($chennaiAreaSelect.find('option').length <= 1) {
        const chennaiAreas = ["", "Adyar", "Alwarpet", "Ambattur", "Anna Salai (Mount Road)", "Ashok Nagar", "Avadi", "Besant Nagar", "Choolaimedu", "Chrompet", "Egmore", "Ennore", "Guindy", "Iyyappanthangal", "Karapakkam", "Kelambakkam", "KK Nagar", "Kodambakkam", "Korukkupet", "Koyambedu", "Madhavaram", "Madipakkam", "Manali", "Medavakkam", "Mogappair", "Mylapore", "Navalur", "Nungambakkam", "Palavakkam", "Pallikaranai", "Perambur", "Perungudi", "Poonamallee", "Porur", "Royapettah", "Royapuram", "Saidapet", "Santhome", "Selaiyur", "Sholinganallur", "Siruseri", "Sowcarpet", "T. Nagar (Thyagaraya Nagar)", "Tambaram", "Teynampet", "Thiruvanmiyur", "Thoraipakkam", "Tondiarpet", "Triplicane", "Vadapalani", "Valasaravakkam", "Velachery", "Virugambakkam", "Vyasarpadi", "Washermanpet"];
        chennaiAreas.forEach(a => {
            $chennaiAreaSelect.append(new Option(a, a));
        });
    }

    function updateLocationView() {
        const district = $districtSelect.val();
        if (district === 'Chennai') {
            $chennaiAreaGroup.show();
        } else {
            $chennaiAreaGroup.hide();
        }
        
        const area = $chennaiAreaSelect.val();
        if (district === 'Chennai') {
            locationInput.val(area ? `Chennai - ${area}` : 'Chennai');
        } else {
            locationInput.val(district);
        }
    }

    $districtSelect.on('change', function() {
        if ($(this).val() !== 'Chennai') {
            $chennaiAreaSelect.val('').trigger('change.select2');
        }
        updateLocationView();
    });

    $chennaiAreaSelect.on('change', function() {
        updateLocationView();
    });

    updateLocationView();


    function setupNumericInput(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });
        }
    }

    setupNumericInput('id_phone');
    setupNumericInput('id_alternative_phone');
    
    // Course filtering
    const $categorySelect = $("#id_course_category");
    const $courseSelect = $("#id_course");

    if ($categorySelect.length && $courseSelect.length) {
        let lastCategoryId = null;

        $categorySelect.on("change", function () {
            const categoryId = this.value;

            if (categoryId && categoryId !== lastCategoryId) {
                lastCategoryId = categoryId;
                $courseSelect.html('<option value="">Select Course</option>').trigger('change');

                fetch(`/students/get-courses/?category_id=${categoryId}`)
                    .then(response => response.ok ? response.json() : Promise.reject('Network response was not ok'))
                    .then(data => {
                        if ($categorySelect.val() === categoryId) {
                            data.forEach(course => {
                                if (!$courseSelect.find(`option[value="${course.id}"]`).length) {
                                    $courseSelect.append(new Option(course.name, course.id));
                                }
                            });
                            $courseSelect.trigger('change');
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        lastCategoryId = null;
                    });
            } else if (!categoryId) {
                $courseSelect.html('<option value="">Select Course</option>').trigger('change');
                lastCategoryId = null;
            }
        });
    }
    
    // EMI script
    const $emiType = $("#id_emi_type");
    const emiFieldGroups = {
        '1': [$("#emi_1_amount_group"), $("#emi_1_date_group")],
        '2': [$("#emi_2_amount_group"), $("#emi_2_date_group")],
        '3': [$("#emi_3_amount_group"), $("#emi_3_date_group")],
        '4': [$("#emi_4_amount_group"), $("#emi_4_date_group")]
    };

    function toggleEMIFields() {
        let selectedType = parseInt($emiType.val(), 10) || 0;
        
        for (let i = 1; i <= 4; i++) {
            const isVisible = i <= selectedType;
            if (emiFieldGroups[i]) {
                emiFieldGroups[i].forEach($group => {
                    if ($group.length) {
                        $group.toggle(isVisible);
                        $group.find('input').prop('required', isVisible);
                    }
                });
            }
        }
    }

    $emiType.on('change', toggleEMIFields);
    toggleEMIFields();

    // Working status script
    const $workingStatusSelect = $('#id_working_status');
    const $itExperienceGroup = $('#it_experience_group');
    
    function toggleItExperience() {
        if ($workingStatusSelect.val() === 'YES') {
            $itExperienceGroup.show();
        } else {
            $itExperienceGroup.hide();
        }
    }

    $workingStatusSelect.on('change', toggleItExperience);
    toggleItExperience();

    function validateEMIAmounts() {
        const totalFees = parseFloat($('#id_total_fees').val()) || 0;
        const amountPaid = parseFloat($('#id_amount_paid').val()) || 0;
        const expectedEMISum = totalFees - amountPaid;

        let actualEMISum = 0;
        // Use a more specific selector for EMI amount fields
        $('input[id^="id_emi_"][id$="_amount"]').each(function() {
            // Check if the parent form group is visible
            if ($(this).closest('.form-group.emi-field').is(':visible')) {
                actualEMISum += parseFloat($(this).val()) || 0;
            }
        });

        const errorMessage = $('#emi-error-message');
        const submitButton = $('#submit-button');

        // Use a small tolerance for floating point comparison
        if (Math.abs(actualEMISum - expectedEMISum) > 0.01) {
            errorMessage.text(`Sum of EMI amounts (${actualEMISum.toFixed(2)}) must equal Pending Amount (${expectedEMISum.toFixed(2)}).`);
            errorMessage.show();
            submitButton.prop('disabled', true);
        } else {
            errorMessage.hide();
            submitButton.prop('disabled', false);
        }
    }

    // Use event delegation for all payment fields
    $('.student-form').on('input', '#id_total_fees, #id_amount_paid, input[id^="id_emi_"][id$="_amount"]', validateEMIAmounts);

    $emiType.on("change", function() {
        toggleEMIFields();
        validateEMIAmounts(); // Re-validate when EMI type changes
    });

    // Initial validation on page load
    validateEMIAmounts();

    // Final check on form submission
    $('form.student-form').on('submit', function(e) {
        validateEMIAmounts(); // Run validation one last time
        if ($('#submit-button').is(':disabled')) {
            e.preventDefault();
            // The error message is already visible, but an alert can be more prominent
            alert('Please correct the payment details. The sum of EMI amounts does not match the pending amount.');
        }
    });
});
</script>
{% endblock %}
{% endblock %}
