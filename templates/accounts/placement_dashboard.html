{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_dashboard.css' %}">
{% endblock %}

{% block title %}Placement Dashboard{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="row my-4 ms-1">
        <div class="col-md-12">
            <h2>Hey, {{ user.name }}!</h2>
            <p>Here's an overview of the current placement status.</p>
        </div>
    </div>

    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-header">
                <i class="fas fa-users stat-icon"></i>
                <h3 class="stat-title">Total Placement Pool</h3>
            </div>
            <p class="stat-value">{{ total_placement_pool }}</p>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <i class="fas fa-search stat-icon"></i>
                <h3 class="stat-title">Actively Seeking</h3>
            </div>
            <p class="stat-value">{{ actively_seeking }}</p>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <i class="fas fa-user-check stat-icon"></i>
                <h3 class="stat-title">Total Placed</h3>
            </div>
            <p class="stat-value">{{ total_placed }}</p>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <i class="fas fa-chart-line stat-icon"></i>
                <h3 class="stat-title">Placement Rate</h3>
            </div>
            <p class="stat-value">{{ placement_rate }}%</p>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <i class="fas fa-building stat-icon"></i>
                <h3 class="stat-title">Active Drives</h3>
            </div>
            <p class="stat-value">{{ active_drives_count }}</p>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <i class="fas fa-calendar-check stat-icon"></i>
                <h3 class="stat-title">Interviews Scheduled</h3>
            </div>
            <p class="stat-value">{{ interviews_scheduled }}</p>
        </div>
    </div>

    <div class="info-card mt-4">
        <div class="info-header">
            <a href="{% url 'pending_resumes_list' %}" class="info-title-link" style="text-decoration: none; color: inherit;">
                <h4 class="info-title"><i class="fas fa-file-alt"></i> Resumes to Collect</h4>
            </a>
            <span class="info-count">{{ resumes_to_collect_count }} Total</span>
        </div>
        <div class="stats-overview">
            <div class="stat-card clickable-stat" data-table-id="completed-table" style="cursor: pointer;">
                <div class="stat-header">
                    <i class="fas fa-check-circle stat-icon" style="color: #2ecc71;"></i>
                    <h3 class="stat-title">Completed</h3>
                </div>
                <p class="stat-value">{{ completed_but_no_resume }}</p>
            </div>
            <div class="stat-card clickable-stat" data-table-id="progress-80-99-table" style="cursor: pointer;">
                <div class="stat-header">
                    <i class="fas fa-tasks stat-icon" style="color: #f1c40f;"></i>
                    <h3 class="stat-title">80-99% Progress</h3>
                </div>
                <p class="stat-value">{{ in_progress_80_99_no_resume }}</p>
            </div>
            <div class="stat-card clickable-stat" data-table-id="progress-50-80-table" style="cursor: pointer;">
                <div class="stat-header">
                    <i class="fas fa-tasks stat-icon" style="color: #f1c40f;"></i>
                    <h3 class="stat-title">50-80% Progress</h3>
                </div>
                <p class="stat-value">{{ in_progress_50_80_no_resume }}</p>
            </div>
            <div class="stat-card clickable-stat" data-table-id="progress-below-50-table" style="cursor: pointer;">
                <div class="stat-header">
                    <i class="fas fa-spinner stat-icon" style="color: #3498db;"></i>
                    <h3 class="stat-title">50% Progress</h3>
                </div>
                <p class="stat-value">{{ in_progress_below_50_no_resume }}</p>
            </div>
            <div class="stat-card clickable-stat" data-table-id="yts-table" style="cursor: pointer;">
                <div class="stat-header">
                    <i class="fas fa-hourglass-start stat-icon" style="color: #95a5a6;"></i>
                    <h3 class="stat-title">Yet to Start</h3>
                </div>
                <p class="stat-value">{{ yts_no_resume }}</p>
            </div>
        </div>
    </div>

    {% with students=completed_list_paginated table_id="completed-table" title="Completed - Pending Resume" page_param="completed_page" %}
        {% include "includes/student_resume_table.html" %}
    {% endwith %}
    {% with students=progress_80_99_list_paginated table_id="progress-80-99-table" title="80-99% Progress - Pending Resume" page_param="progress_80_99_page" %}
        {% include "includes/student_resume_table.html" %}
    {% endwith %}
    {% with students=progress_50_80_list_paginated table_id="progress-50-80-table" title="50-80% Progress - Pending Resume" page_param="progress_50_80_page" %}
        {% include "includes/student_resume_table.html" %}
    {% endwith %}
    {% with students=progress_below_50_list_paginated table_id="progress-below-50-table" title="<50% Progress - Pending Resume" page_param="progress_below_50_page" %}
        {% include "includes/student_resume_table.html" %}
    {% endwith %}
    {% with students=yts_list_paginated table_id="yts-table" title="Yet to Start - Pending Resume" page_param="yts_page" %}
        {% include "includes/student_resume_table.html" %}
    {% endwith %}

    <div class="dashboard-grid mt-4">
        <div class="info-card">
            <div class="info-header">
                <h4 class="info-title"><i class="fas fa-calendar-alt"></i> Upcoming Interviews</h4>
                <a href="#" class="view-all">View All</a>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <tbody>
                        {% for interview in upcoming_interviews %}
                        <tr>
                            <td>{{ interview.placement.student.first_name }} {{ interview.placement.student.last_name }}</td>
                            <td>{{ interview.company.company_name }}</td>
                            <td>{{ interview.interview_date|date:"d M Y" }}</td>
                            <td>{{ interview.interview_time|time:"H:i" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="no-data">No upcoming interviews.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="info-card">
            <div class="info-header">
                <h4 class="info-title"><i class="fas fa-user-clock"></i> Students Yet to be Placed</h4>
                <a href="#" class="view-all">View All</a>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <tbody>
                        {% for placement in students_yet_to_be_placed %}
                        <tr>
                            <td>{{ placement.student.first_name }} {{ placement.student.last_name }}</td>
                            <td>{{ placement.student.get_course_status_display }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="2" class="no-data">No students are currently seeking placement.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="info-card mt-4">
        <div class="info-header">
            <h4 class="info-title"><i class="fas fa-user-graduate"></i> Recently Placed Students</h4>
            <a href="#" class="view-all">View All</a>
        </div>
        <div class="table-responsive">
            <table class="table table-hover">
                <tbody>
                    {% for student in recently_placed %}
                    <tr>
                        <td>{{ student.first_name }} {{ student.last_name }}</td>
                        <td>{{ student.course.name|default:"-" }}</td>
                        <td>{{ student.end_date|date:"d M Y" }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="no-data">No students have been placed recently.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const clickableStats = document.querySelectorAll('.clickable-stat');
    const tables = document.querySelectorAll('.student-resume-table');

    // Function to show a table and hide others
    function showTable(tableId) {
        tables.forEach(t => {
            t.style.display = t.id === tableId ? 'block' : 'none';
        });
    }

    // Check for page parameters on load to show the correct table
    const urlParams = new URLSearchParams(window.location.search);
    const pageParams = ['completed_page', 'progress_80_99_page', 'progress_50_80_page', 'progress_below_50_page', 'yts_page'];
    let activeTableId = null;

    pageParams.forEach(param => {
        if (urlParams.has(param)) {
            switch(param) {
                case 'completed_page': activeTableId = 'completed-table'; break;
                case 'progress_80_99_page': activeTableId = 'progress-80-99-table'; break;
                case 'progress_50_80_page': activeTableId = 'progress-50-80-table'; break;
                case 'progress_below_50_page': activeTableId = 'progress-below-50-table'; break;
                case 'yts_page': activeTableId = 'yts-table'; break;
            }
        }
    });

    if (activeTableId) {
        showTable(activeTableId);
    }

    // Add click listeners to stat cards
    clickableStats.forEach(stat => {
        stat.addEventListener('click', function() {
            const tableId = this.dataset.tableId;
            const table = document.getElementById(tableId);
            
            if (table.style.display === 'none' || table.style.display === '') {
                showTable(tableId);
            } else {
                table.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}