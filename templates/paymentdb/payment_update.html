{% extends "base.html" %}
{% block title %}Update Payment{% endblock %}

{% block content %}
<div class="payment-update">
    <h2>Update Payment - {{ payment.student.name }} ({{ payment.student.student_id }})</h2>

    <!-- Initial Payment Details -->
    <div class="initial-payment-section">
        <h3>Initial Payment Details</h3>
        <div class="payment-details">
            <div class="detail-row">
                <label>Amount:</label>
                <span>₹{{ payment.amount_paid }}</span>
            </div>
            <div class="detail-row">
                <label>Payment Proof:</label>
                {% if payment.initial_payment_proof %}
                    <a href="{{ payment.initial_payment_proof.url }}" target="_blank" class="proof-link">View Proof</a>
                {% else %}
                    <span class="no-proof">No proof available</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Payment Summary -->
    <div class="payment-summary">
        <div class="summary-item">
            <label>Total Fees:</label>
            <span>₹{{ payment.total_fees }}</span>
        </div>
        <div class="summary-item">
            <label>Total Pending:</label>
            <span>₹{{ payment.calculate_total_pending }}</span>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="error-messages">
            {{ form.non_field_errors }}
        </div>
        {% endif %}

        <!-- EMI Details -->
        {% if payment.emi_type != 'NONE' %}
            {% if payment.emi_1_amount %}
            <div class="emi-section {% if payment.emi_1_paid_amount %}paid-emi{% elif not payment.emi_1_paid_amount and form.fields.emi_1_paid_amount.disabled == False %}current-emi{% else %}pending-emi{% endif %}">
                <h3>EMI 1</h3>
                <div class="emi-details">
                    <div class="emi-row">
                        <label>Original Amount:</label>
                        <span>₹{{ payment.emi_1_amount }}</span>
                    </div>
                    <div class="emi-row">
                        <label>Due Date:</label>
                        <span>{{ payment.emi_1_date }}</span>
                    </div>
                    {% if payment.emi_1_paid_amount %}
                    <div class="emi-row paid-amount">
                        <label>Paid Amount:</label>
                        <span>₹{{ payment.emi_1_paid_amount }}</span>
                        <span class="paid-date">(Paid on: {{ payment.emi_1_paid_date }})</span>
                        {% if payment.emi_1_proof %}
                            <a href="{{ payment.emi_1_proof.url }}" target="_blank" class="proof-link">View Proof</a>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="emi-row">
                        <label>Paid Amount:</label>
                        {{ form.emi_1_paid_amount }}
                    </div>
                    <div class="emi-row">
                        <label>Paid Date:</label>
                        {{ form.emi_1_paid_date }}
                    </div>
                    <div class="emi-row">
                        <label>Payment Proof:</label>
                        {{ form.emi_1_proof }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if payment.emi_2_amount %}
            <div class="emi-section {% if payment.emi_2_paid_amount %}paid-emi{% elif not payment.emi_2_paid_amount and form.fields.emi_2_paid_amount.disabled == False %}current-emi{% else %}pending-emi{% endif %}">
                <h3>EMI 2</h3>
                <div class="emi-details">
                    <div class="emi-row">
                        <label>Original Amount:</label>
                        <span>₹{{ payment.emi_2_amount }}</span>
                    </div>
                    <div class="emi-row">
                        <label>Due Date:</label>
                        <span>{{ payment.emi_2_date }}</span>
                    </div>
                    {% if payment.emi_2_paid_amount %}
                    <div class="emi-row paid-amount">
                        <label>Paid Amount:</label>
                        <span>₹{{ payment.emi_2_paid_amount }}</span>
                        <span class="paid-date">(Paid on: {{ payment.emi_2_paid_date }})</span>
                        {% if payment.emi_2_proof %}
                            <a href="{{ payment.emi_2_proof.url }}" target="_blank" class="proof-link">View Proof</a>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="emi-row">
                        <label>Paid Amount:</label>
                        {{ form.emi_2_paid_amount }}
                    </div>
                    <div class="emi-row">
                        <label>Paid Date:</label>
                        {{ form.emi_2_paid_date }}
                    </div>
                    <div class="emi-row">
                        <label>Payment Proof:</label>
                        {{ form.emi_2_proof }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if payment.emi_3_amount %}
            <div class="emi-section {% if payment.emi_3_paid_amount %}paid-emi{% elif not payment.emi_3_paid_amount and form.fields.emi_3_paid_amount.disabled == False %}current-emi{% else %}pending-emi{% endif %}">
                <h3>EMI 3</h3>
                <div class="emi-details">
                    <div class="emi-row">
                        <label>Original Amount:</label>
                        <span>₹{{ payment.emi_3_amount }}</span>
                    </div>
                    <div class="emi-row">
                        <label>Due Date:</label>
                        <span>{{ payment.emi_3_date }}</span>
                    </div>
                    {% if payment.emi_3_paid_amount %}
                    <div class="emi-row paid-amount">
                        <label>Paid Amount:</label>
                        <span>₹{{ payment.emi_3_paid_amount }}</span>
                        <span class="paid-date">(Paid on: {{ payment.emi_3_paid_date }})</span>
                        {% if payment.emi_3_proof %}
                            <a href="{{ payment.emi_3_proof.url }}" target="_blank" class="proof-link">View Proof</a>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="emi-row">
                        <label>Paid Amount:</label>
                        {{ form.emi_3_paid_amount }}
                    </div>
                    <div class="emi-row">
                        <label>Paid Date:</label>
                        {{ form.emi_3_paid_date }}
                    </div>
                    <div class="emi-row">
                        <label>Payment Proof:</label>
                        {{ form.emi_3_proof }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if payment.emi_4_amount %}
            <div class="emi-section {% if payment.emi_4_paid_amount %}paid-emi{% elif not payment.emi_4_paid_amount and form.fields.emi_4_paid_amount.disabled == False %}current-emi{% else %}pending-emi{% endif %}">
                <h3>EMI 4</h3>
                <div class="emi-details">
                    <div class="emi-row">
                        <label>Original Amount:</label>
                        <span>₹{{ payment.emi_4_amount }}</span>
                    </div>
                    <div class="emi-row">
                        <label>Due Date:</label>
                        <span>{{ payment.emi_4_date }}</span>
                    </div>
                    {% if payment.emi_4_paid_amount %}
                    <div class="emi-row paid-amount">
                        <label>Paid Amount:</label>
                        <span>₹{{ payment.emi_4_paid_amount }}</span>
                        <span class="paid-date">(Paid on: {{ payment.emi_4_paid_date }})</span>
                        {% if payment.emi_4_proof %}
                            <a href="{{ payment.emi_4_proof.url }}" target="_blank" class="proof-link">View Proof</a>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="emi-row">
                        <label>Paid Amount:</label>
                        {{ form.emi_4_paid_amount }}
                    </div>
                    <div class="emi-row">
                        <label>Paid Date:</label>
                        {{ form.emi_4_paid_date }}
                    </div>
                    <div class="emi-row">
                        <label>Payment Proof:</label>
                        {{ form.emi_4_proof }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        {% endif %}

        <div class="form-actions">
            <button type="submit">Save Changes</button>
            <a href="{% url 'payment_list' %}" class="cancel-button">Cancel</a>
        </div>
    </form>
</div>

<style>
.payment-update {
    padding: 20px;
    max-width: 800px;
    margin: 0 auto;
}

.initial-payment-section {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.payment-summary {
    background-color: #e9ecef;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
}

.summary-item {
    flex: 1;
    text-align: center;
}

.emi-section {
    margin: 20px 0;
    padding: 15px;
    border-radius: 5px;
    border: 1px solid #ddd;
}

.current-emi {
    border: 2px solid #007bff;
    background-color: #f8f9fa;
}

.paid-emi {
    background-color: #d4edda;
    border-color: #c3e6cb;
}

.pending-emi {
    background-color: #fff3cd;
    border-color: #ffeeba;
}

.emi-details {
    margin-top: 10px;
}

.emi-row {
    margin: 10px 0;
    display: flex;
    align-items: center;
}

.emi-row label {
    min-width: 150px;
    font-weight: bold;
}

.paid-amount {
    color: #28a745;
}

.paid-date {
    margin-left: 10px;
    color: #6c757d;
}

.proof-link {
    margin-left: 10px;
    color: #007bff;
    text-decoration: none;
}

.proof-link:hover {
    text-decoration: underline;
}

.form-actions {
    margin-top: 20px;
    text-align: center;
}

.form-actions button {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    margin-right: 10px;
}

.cancel-button {
    background-color: #6c757d;
    color: white;
    text-decoration: none;
    padding: 10px 20px;
    border-radius: 5px;
    display: inline-block;
}

.error-messages {
    color: #dc3545;
    margin: 10px 0;
    padding: 10px;
    border: 1px solid #dc3545;
    border-radius: 5px;
    background-color: #f8d7da;
}

.no-proof {
    color: #6c757d;
    font-style: italic;
}
</style>
{% endblock %}
