{% extends "base.html" %}
{% load static %}
{% load core_tags %}
{% block title %}Update Course{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/student_form_modern.css' %}">
<link rel="stylesheet" href="{% static 'css/course_form.css' %}">
{% endblock %}

{% block content %}
<div class="student-form-container">
    <div class="form-header">
        <h1>Update Course</h1>
        <p class="form-subtitle">Update the details for the course</p>
    </div>

    <form method="post" class="student-form">
        {% csrf_token %}
        {% if form.non_field_errors or module_formset.non_form_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
                {{ module_formset.non_form_errors }}
            </div>
        {% endif %}
        <div class="form-section-card">
            <div class="form-section-header">
                <h5 style="color: white;"><i class="fas fa-book me-2" style="color: white;"></i>Course Details</h5>
            </div>
            <div class="form-section-body">
                {{ form.as_p }}
            </div>
        </div>

        <div class="form-section-card">
            <div class="form-section-header">
                <h5 style="color: white;"><i class="fas fa-cogs me-2" style="color: white;"></i>Modules</h5>
            </div>
            <div class="form-section-body">
                {{ module_formset.management_form }}
                <div id="modules-container">
                    {% for module_form in module_formset %}
                    <div class="module-form" id="{{ module_form.prefix }}">
                        {{ module_form.id }}
                        <div class="d-flex justify-content-end">{{ module_form.DELETE }} <label for="{{ module_form.DELETE.id_for_label }}">Remove</label></div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Module Name<span class="required-indicator">*</span></label>
                                    {{ module_form.name }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Module Hours<span class="required-indicator">*</span></label>
                                    {{ module_form.module_duration }}
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label style="font-weight:normal;">
                                {{ module_form.has_topics }}
                                Has Topics?
                            </label>
                        </div>
                        <div class="topics-section {% if not module_form.instance.has_topics %}d-none{% endif %}">
                            <h6>Topics</h6>
                            {% with topic_formsets|get_item:module_form.prefix as topic_formset %}
                            {{ topic_formset.management_form }}
                            <div class="topic-forms-container">
                                {% for topic_form in topic_formset %}
                                <div class="topic-form" id="{{ topic_form.prefix }}">
                                    {{ topic_form.id }}
                                    <div class="d-flex justify-content-end">{{ topic_form.DELETE }} <label for="{{ topic_form.DELETE.id_for_label }}">Remove</label></div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Topic Name<span class="required-indicator">*</span></label>
                                                {{ topic_form.name }}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Topic Hours<span class="required-indicator">*</span></label>
                                                {{ topic_form.topic_duration }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-sm btn-secondary add-topic-btn">Add Topic</button>
                            {% endwith %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-primary" id="add-module-btn">Add Module</button>
            </div>
        </div>
        <div id="duration-validation-message"></div>
         <div class="form-actions">
             <button type="submit" class="btn btn-success">Update Course</button>
         </div>
    </form>
</div>

<template id="module-template">
    <div class="module-form" id="modules-__prefix__">
        <div class="d-flex justify-content-end"><input type="checkbox" name="modules-__prefix__-DELETE" id="id_modules-__prefix__-DELETE"> <label for="id_modules-__prefix__-DELETE">Remove</label></div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label>Module Name<span class="required-indicator">*</span></label>
                    <input type="text" name="modules-__prefix__-name" class="form-control">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label>Module Hours<span class="required-indicator">*</span></label>
                    <input type="number" name="modules-__prefix__-module_duration" min="1" class="form-control">
                </div>
            </div>
        </div>
        <div class="form-group">
            <label style="font-weight:normal;">
                <input type="checkbox" name="modules-__prefix__-has_topics" class="has-topics-checkbox">
                Has Topics?
            </label>
        </div>
        <div class="topics-section d-none">
            <h6>Topics</h6>
            <div class="topic-forms-container"></div>
            <button type="button" class="btn btn-sm btn-secondary add-topic-btn">Add Topic</button>
        </div>
    </div>
</template>

<template id="topic-template">
    <div class="topic-form" id="topics-modules-__module_prefix__-__prefix__">
        <div class="d-flex justify-content-end"><input type="checkbox" name="topics-modules-__module_prefix__-__prefix__-DELETE" id="id_topics-modules-__module_prefix__-__prefix__-DELETE"> <label for="id_topics-modules-__module_prefix__-__prefix__-DELETE">Remove</label></div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label>Topic Name<span class="required-indicator">*</span></label>
                    <input type="text" name="topics-modules-__module_prefix__-__prefix__-name" class="form-control">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label>Topic Hours<span class="required-indicator">*</span></label>
                    <input type="number" name="topics-modules-__module_prefix__-__prefix__-topic_duration" min="1" class="form-control">
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/course_form.js' %}"></script>
{% endblock %}