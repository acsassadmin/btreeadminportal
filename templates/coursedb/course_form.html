{% extends "base.html" %}
{% load static %}
{% block title %}Create Course{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/student_form_modern.css' %}">
<style>
    .module-form, .topic-form {
        background: #f5f8fc;
        border: 1px solid #dbeafe;
        border-radius: 6px;
        padding: 15px 16px;
        margin-bottom: 15px;
        position: relative;
    }
    .module-form > .remove-module-btn,
    .topic-form > .remove-topic-btn {
        position: absolute;
        right: 12px;
        top: 12px;
    }
    .topics-section {
        margin-top: 10px;
        margin-left: 30px;
        border-left: 3px solid #c7e5fc;
        padding-left: 21px;
        background: #fafdff;
    }
</style>
{% endblock %}

{% block content %}
<div class="student-form-container">
    <div class="form-header">
        <h1>Create Course</h1>
        <p class="form-subtitle">Enter the details to create a new course</p>
    </div>

    <form method="post" class="student-form">
        {% csrf_token %}
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}
        {% if formset.non_form_errors %}
            <div class="alert alert-danger">
                {{ formset.non_form_errors }}
            </div>
        {% endif %}
        <div class="form-section-card">
            <div class="form-section-header">
                <h5 style="color: white;"><i class="fas fa-book me-2" style="color: white;"></i>Course Details</h5>
            </div>
            <div class="form-section-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="label-form">
                                {{ form.code.label_tag }}
                            </div>
                            {{ form.code }}
                            <div class="error-message">{{ form.code.errors }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="label-form">
                                {{ form.course_name.label_tag }}
                                <span class="required-indicator">*</span>
                            </div>
                            {{ form.course_name }}
                            <div class="error-message">{{ form.course_name.errors }}</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="label-form">
                                {{ form.course_type.label_tag }}
                                <span class="required-indicator">*</span>
                            </div>
                            {{ form.course_type }}
                            <div class="error-message">{{ form.course_type.errors }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="label-form">
                                {{ form.category.label_tag }}
                                <span class="required-indicator">*</span>
                            </div>
                            {{ form.category }}
                            <div class="error-message">{{ form.category.errors }}</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="label-form">
                                {{ form.total_duration.label_tag }}
                                <span class="required-indicator">*</span>
                            </div>
                            {{ form.total_duration }}
                            <div class="error-message">{{ form.total_duration.errors }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section-card">
            <div class="form-section-header">
                <h5 style="color: white;"><i class="fas fa-cogs me-2" style="color: white;"></i>Modules</h5>
            </div>
            <div class="form-section-body">
                <div id="modules-container"></div>
                <button type="button" class="btn btn-primary" id="add-module-btn">Add Module</button>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-success">Save Course</button>
        </div>

        <!-- Templates - hidden but present in DOM -->
        <template id="module-template">
            <div class="module-form">
                <button type="button" class="btn btn-danger btn-sm remove-module-btn">Remove</button>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Module Name</label>
                            <input type="text" name="module_name" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Module Hours</label>
                            <input type="number" name="module_hours" min="1" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label style="font-weight:normal;">
                        <input type="checkbox" name="has_topics" class="has-topics-checkbox">
                        Has Topics?
                    </label>
                </div>
                <div class="topics-section" style="display:none;">
                    <div class="topic-forms-container"></div>
                    <button type="button" class="btn btn-sm btn-secondary add-topic-btn">Add Topic</button>
                </div>
            </div>
        </template>
        <template id="topic-template">
            <div class="topic-form">
                <button type="button" class="btn btn-danger btn-sm remove-topic-btn">Remove</button>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Topic Name</label>
                            <input type="text" name="topic_name" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Topic Hours</label>
                            <input type="number" name="topic_hours" min="1" class="form-control">
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CREATE A NEW MODULE FORM
function addModule() {
    const tmpl = document.getElementById('module-template').content.cloneNode(true);
    const moduleDiv = tmpl.querySelector('.module-form');
    // Attach all button events
    attachModuleEvents(moduleDiv);
    document.getElementById('modules-container').appendChild(moduleDiv);
}

// MODULE EVENTS (add/remove topics, toggle show/hide on checkbox)
function attachModuleEvents(moduleDiv) {
    moduleDiv.querySelector('.remove-module-btn').onclick = function() {
        moduleDiv.remove();
    };
    const hasTopics = moduleDiv.querySelector('.has-topics-checkbox');
    const topicsSection = moduleDiv.querySelector('.topics-section');
    const addTopicBtn = moduleDiv.querySelector('.add-topic-btn');
    const topicFormsContainer = moduleDiv.querySelector('.topic-forms-container');
    // Show topics section and auto-add first topic
    hasTopics.onchange = function() {
        if (hasTopics.checked) {
            topicsSection.style.display = 'block';
            // If section is empty, add a topic row
            if (!topicFormsContainer.querySelector('.topic-form')) {
                addTopicToModule(moduleDiv);
            }
        } else {
            topicsSection.style.display = 'none';
            topicFormsContainer.innerHTML = '';
        }
    };
    addTopicBtn.onclick = function() {
        addTopicToModule(moduleDiv);
    };
}

// CREATE NEW TOPIC ROW
function addTopicToModule(moduleDiv) {
    const tmpl = document.getElementById('topic-template').content.cloneNode(true);
    const topicDiv = tmpl.querySelector('.topic-form');
    topicDiv.querySelector('.remove-topic-btn').onclick = function() {
        topicDiv.remove();
    };
    moduleDiv.querySelector('.topic-forms-container').appendChild(topicDiv);
}

// Add the first starter module for user-friendliness
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('id_category');
    const codeInput = document.getElementById('id_code');

    if (categorySelect && codeInput) {
        categorySelect.addEventListener('change', function() {
            const categoryId = this.value;
            if (categoryId) {
                fetch(`/coursedb/ajax/get_next_course_code/?category_id=${categoryId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.next_code) {
                            codeInput.value = data.next_code;
                        }
                    })
                    .catch(error => console.error('Error fetching next course code:', error));
            }
        });
    }
    
    if (document.getElementById('add-module-btn')) {
        document.getElementById('add-module-btn').onclick = addModule;
        addModule();
    }
});
</script>
{% endblock %}
