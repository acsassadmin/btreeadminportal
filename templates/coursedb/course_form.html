{% extends "base.html" %}
{% block title %}{% if form.instance.pk %}Edit{% else %}Create{% endif %} Course{% endblock %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/student_form_modern.css' %}">
<style>
    .topic-form .form-control {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }
    .topics-section {
        padding-left: 20px;
        border-left: 2px solid #eee;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="student-form-container">
    <div class="form-header">
        <h1>{% if form.instance.pk %}Edit{% else %}Create{% endif %} Course</h1>
    </div>

    <form method="post" class="student-form">
        {% csrf_token %}
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}
        {% if formset.non_form_errors %}
            <div class="alert alert-danger">
                {{ formset.non_form_errors }}
            </div>
        {% endif %}
        <div class="form-section-card">
            <div class="form-section-header">
                <h5 style="color: white;"><i class="fas fa-book me-2" style="color: white;"></i>Course Details</h5>
            </div>
            <div class="form-section-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="label-form">
                                {{ form.code.label_tag }}
                            </div>
                            {{ form.code }}
                            <div class="error-message">{{ form.code.errors }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="label-form">
                                {{ form.course_name.label_tag }}
                                <span class="required-indicator">*</span>
                            </div>
                            {{ form.course_name }}
                            <div class="error-message">{{ form.course_name.errors }}</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="label-form">
                                {{ form.course_type.label_tag }}
                                <span class="required-indicator">*</span>
                            </div>
                            {{ form.course_type }}
                            <div class="error-message">{{ form.course_type.errors }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="label-form">
                                {{ form.category.label_tag }}
                                <span class="required-indicator">*</span>
                            </div>
                            {{ form.category }}
                            <div class="error-message">{{ form.category.errors }}</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="label-form">
                                {{ form.total_duration.label_tag }}
                                <span class="required-indicator">*</span>
                            </div>
                            {{ form.total_duration }}
                            <div class="error-message">{{ form.total_duration.errors }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="modules-section" class="form-section-card">
            <div class="form-section-header">
                <h5 style="color: white;"><i class="fas fa-puzzle-piece me-2" style="color: white;"></i>Modules</h5>
            </div>
            <div class="form-section-body">
                {{ formset.management_form }}
                {{ formset.non_form_errors }}
                <div id="module-forms-container">
                    {% for form in formset %}
                        <div class="module-form">
                            {{ form.id }}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ form.name.label_tag }}
                                        {{ form.name }}
                                        {{ form.name.errors }}
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="form-group">
                                        {{ form.module_duration.label_tag }}
                                        {{ form.module_duration }}
                                        {{ form.module_duration.errors }}
                                    </div>
                                </div>
                                <div class="col-md-1 d-flex align-items-center">
                                    {% if form.instance.pk %}
                                        <div style="display:none;">{{ form.DELETE }}</div>
                                        <button type="button" class="btn btn-danger remove-module-btn"><i class="fas fa-times"></i></button>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-check">
                                        {{ form.has_topics }}
                                        <label class="form-check-label" for="{{ form.has_topics.id_for_label }}">Has Topics</label>
                                    </div>
                                </div>
                            </div>
                            <div class="topics-section" style="display: {% if form.instance.has_topics %}block{% else %}none{% endif %};">
                                <h6>Topics</h6>
                                <div class="topic-forms-container">
                                    {{ form.topic_formset.management_form }}
                                    {% for topic_form in form.topic_formset %}
                                        <div class="topic-form">
                                            {{ topic_form.id }}
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        {{ topic_form.name.label_tag }}
                                                        {{ topic_form.name }}
                                                        {{ topic_form.name.errors }}
                                                    </div>
                                                </div>
                                                <div class="col-md-5">
                                                    <div class="form-group">
                                                        {{ topic_form.topic_duration.label_tag }}
                                                        {{ topic_form.topic_duration }}
                                                        {{ topic_form.topic_duration.errors }}
                                                    </div>
                                                </div>
                                                <div class="col-md-1 d-flex align-items-center">
                                                    {% if topic_form.instance.pk %}
                                                        <div style="display:none;">{{ topic_form.DELETE }}</div>
                                                        <button type="button" class="btn btn-danger remove-topic-btn"><i class="fas fa-times"></i></button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <div class="empty-topic-form-template" style="display:none">
                                    <div class="topic-form">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{ form.topic_formset.empty_form.name.label_tag }}
                                                    {{ form.topic_formset.empty_form.name }}
                                                    {{ form.topic_formset.empty_form.name.errors }}
                                                </div>
                                            </div>
                                            <div class="col-md-5">
                                                <div class="form-group">
                                                    {{ form.topic_formset.empty_form.topic_duration.label_tag }}
                                                    {{ form.topic_formset.empty_form.topic_duration }}
                                                    {{ form.topic_formset.empty_form.topic_duration.errors }}
                                                </div>
                                            </div>
                                            <div class="col-md-1 d-flex align-items-center">
                                                <button type="button" class="btn btn-danger remove-topic-btn"><i class="fas fa-times"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-secondary add-topic-btn">Add Topic</button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <div id="empty-form-template" style="display:none">
                    <div class="module-form">
                        {{ formset.empty_form.id }}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ formset.empty_form.name.label_tag }}
                                    {{ formset.empty_form.name }}
                                    {{ formset.empty_form.name.errors }}
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="form-group">
                                    {{ formset.empty_form.module_duration.label_tag }}
                                    {{ formset.empty_form.module_duration }}
                                    {{ formset.empty_form.module_duration.errors }}
                                </div>
                            </div>
                            <div class="col-md-1 d-flex align-items-center">
                                <button type="button" class="btn btn-danger remove-module-btn"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-check">
                                    {{ formset.empty_form.has_topics }}
                                    <label class="form-check-label" for="{{ formset.empty_form.has_topics.id_for_label }}">Has Topics</label>
                                </div>
                            </div>
                        </div>
                        <div class="topics-section" style="display: none;">
                            <h6>Topics</h6>
                            <div class="topic-forms-container">
                                {{ formset.empty_form.topic_formset.management_form }}
                            </div>
                            <div class="empty-topic-form-template" style="display:none">
                                <div class="topic-form">
                                    {{ formset.empty_form.topic_formset.empty_form.id }}
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                {{ formset.empty_form.topic_formset.empty_form.name.label_tag }}
                                                {{ formset.empty_form.topic_formset.empty_form.name }}
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="form-group">
                                                {{ formset.empty_form.topic_formset.empty_form.topic_duration.label_tag }}
                                                {{ formset.empty_form.topic_formset.empty_form.topic_duration }}
                                            </div>
                                        </div>
                                        <div class="col-md-1 d-flex align-items-center">
                                            <button type="button" class="btn btn-danger remove-topic-btn"><i class="fas fa-times"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-secondary add-topic-btn">Add Topic</button>
                        </div>
                    </div>
                </div>
                <button type="button" id="add-module-btn" class="btn btn-secondary">Add Module</button>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" id="save-button" class="btn btn-primary">Save</button>
            <a href="{% url 'coursedb:course_list' %}" class="btn btn-secondary">Cancel</a>
        </div>
        <div id="duration-error" class="alert alert-danger mt-2" style="display: none;"></div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const moduleFormsContainer = document.getElementById('module-forms-container');
    const addModuleBtn = document.getElementById('add-module-btn');
    const totalDurationInput = document.getElementById('id_total_duration');
    const saveButton = document.getElementById('save-button');
    const durationError = document.getElementById('duration-error');

    const updateAndValidate = () => {
        let courseTotal = parseInt(totalDurationInput.value, 10) || 0;
        let modulesTotal = 0;
        let errorMessages = [];

        document.querySelectorAll('.module-form').forEach((moduleForm) => {
            const deleteInput = moduleForm.querySelector(`input[name$="-DELETE"]`);
            if (deleteInput && deleteInput.checked) return;

            const moduleDurationInput = moduleForm.querySelector(`input[name$="-module_duration"]`);
            const moduleDuration = parseInt(moduleDurationInput.value, 10) || 0;
            modulesTotal += moduleDuration;

            const hasTopicsCheckbox = moduleForm.querySelector(`input[name$="-has_topics"]`);
            if (hasTopicsCheckbox && hasTopicsCheckbox.checked) {
                let topicsTotal = 0;
                moduleForm.querySelectorAll('.topic-form').forEach(topicForm => {
                    const topicDeleteInput = topicForm.querySelector(`input[name$="-DELETE"]`);
                    if (!topicDeleteInput || !topicDeleteInput.checked) {
                        const topicDurationInput = topicForm.querySelector(`input[name$="-topic_duration"]`);
                        topicsTotal += parseInt(topicDurationInput.value, 10) || 0;
                    }
                });

                if (moduleDuration !== topicsTotal) {
                    const moduleName = moduleForm.querySelector(`input[name$="-name"]`).value || `This module`;
                    errorMessages.push(`Topics in '${moduleName}' sum to ${topicsTotal}hrs, but module duration is ${moduleDuration}hrs.`);
                }
            }
        });

        if (courseTotal !== modulesTotal) {
            errorMessages.push(`All module durations sum to ${modulesTotal}hrs, but course duration is ${courseTotal}hrs.`);
        }

        durationError.innerHTML = errorMessages.join('<br>');
        durationError.style.display = errorMessages.length > 0 ? 'block' : 'none';
        saveButton.disabled = errorMessages.length > 0;
    };

    const reindexAll = () => {
        const totalModulesInput = document.querySelector('#id_modules-TOTAL_FORMS');
        const moduleForms = document.querySelectorAll('.module-form');
        totalModulesInput.value = moduleForms.length;

        moduleForms.forEach((moduleForm, moduleIndex) => {
            moduleForm.querySelectorAll('input, select, textarea, label').forEach(el => {
                ['id', 'name', 'for'].forEach(attr => {
                    if (el.getAttribute(attr)) {
                        el.setAttribute(attr, el.getAttribute(attr).replace(/modules-\d+/g, `modules-${moduleIndex}`));
                    }
                });
            });

            const totalTopicsInput = moduleForm.querySelector(`input[name$="-topics-TOTAL_FORMS"]`);
            const topicForms = moduleForm.querySelectorAll('.topic-form');
            if (totalTopicsInput) {
                totalTopicsInput.value = topicForms.length;
                topicForms.forEach((topicForm, topicIndex) => {
                    topicForm.querySelectorAll('input, select, textarea, label').forEach(el => {
                        ['id', 'name', 'for'].forEach(attr => {
                            if (el.getAttribute(attr)) {
                                el.setAttribute(attr, el.getAttribute(attr).replace(/topics-\d+/g, `topics-${topicIndex}`));
                            }
                        });
                    });
                });
            }
        });
    };

    document.body.addEventListener('click', e => {
        if (e.target.closest('.add-topic-btn')) {
            const moduleForm = e.target.closest('.module-form');
            const topicFormsContainer = moduleForm.querySelector('.topic-forms-container');
            const emptyFormTemplate = document.getElementById('empty-form-template').querySelector('.empty-topic-form-template').innerHTML;
            
            const div = document.createElement('div');
            div.innerHTML = emptyFormTemplate.replace(/__prefix__/g, '0'); // Placeholder index
            topicFormsContainer.appendChild(div.firstElementChild);
            reindexAll();
        } else if (e.target.closest('.remove-topic-btn')) {
            const topicForm = e.target.closest('.topic-form');
            const deleteInput = topicForm.querySelector(`input[name$="-DELETE"]`);
            if (deleteInput) {
                deleteInput.checked = true;
                topicForm.style.display = 'none';
            } else {
                topicForm.remove();
            }
            reindexAll();
            updateAndValidate();
        } else if (e.target.closest('.remove-module-btn')) {
            const moduleForm = e.target.closest('.module-form');
            const deleteInput = moduleForm.querySelector(`input[name$="-DELETE"]`);
            if (deleteInput) {
                deleteInput.checked = true;
                moduleForm.style.display = 'none';
            } else {
                moduleForm.remove();
            }
            reindexAll();
            updateAndValidate();
        }
    });

    addModuleBtn.addEventListener('click', () => {
        const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;
        const div = document.createElement('div');
        div.innerHTML = emptyFormTemplate.replace(/__prefix__/g, '0'); // Placeholder index
        
        const totalTopicsInput = div.querySelector('input[name$="-topics-TOTAL_FORMS"]');
        if(totalTopicsInput) totalTopicsInput.value = 0;

        moduleFormsContainer.appendChild(div.firstElementChild);
        reindexAll();
    });

    document.body.addEventListener('change', e => {
        if (e.target.matches('input[name$="-has_topics"]')) {
            const topicsSection = e.target.closest('.module-form').querySelector('.topics-section');
            topicsSection.style.display = e.target.checked ? 'block' : 'none';
            updateAndValidate();
        }
    });

    document.body.addEventListener('input', e => {
        if (e.target.matches('input[name$="-module_duration"], input[name$="-topic_duration"], #id_total_duration')) {
            updateAndValidate();
        }
    });

    reindexAll();
    updateAndValidate();
});
</script>
{% endblock %}