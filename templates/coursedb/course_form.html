{% extends "base.html" %}
{% block title %}{% if form.instance.pk %}Edit{% else %}Create{% endif %} Course{% endblock %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/student_form_modern.css' %}">
<style>
    .topic-form .form-control {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }
    .topics-section {
        padding-left: 20px;
        border-left: 2px solid #eee;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="student-form-container">
    <div class="form-header">
        <h1>{% if form.instance.pk %}Edit{% else %}Create{% endif %} Course</h1>
    </div>

    <form method="post" class="student-form">
        {% csrf_token %}
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}
        {% if formset.non_form_errors %}
            <div class="alert alert-danger">
                {{ formset.non_form_errors }}
            </div>
        {% endif %}
        <div class="form-section-card">
            <div class="form-section-header">
                <h5 style="color: white;"><i class="fas fa-book me-2" style="color: white;"></i>Course Details</h5>
            </div>
            <div class="form-section-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="label-form">
                                {{ form.code.label_tag }}
                            </div>
                            {{ form.code }}
                            <div class="error-message">{{ form.code.errors }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="label-form">
                                {{ form.course_name.label_tag }}
                                <span class="required-indicator">*</span>
                            </div>
                            {{ form.course_name }}
                            <div class="error-message">{{ form.course_name.errors }}</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="label-form">
                                {{ form.course_type.label_tag }}
                                <span class="required-indicator">*</span>
                            </div>
                            {{ form.course_type }}
                            <div class="error-message">{{ form.course_type.errors }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="label-form">
                                {{ form.category.label_tag }}
                                <span class="required-indicator">*</span>
                            </div>
                            {{ form.category }}
                            <div class="error-message">{{ form.category.errors }}</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="label-form">
                                {{ form.total_duration.label_tag }}
                                <span class="required-indicator">*</span>
                            </div>
                            {{ form.total_duration }}
                            <div class="error-message">{{ form.total_duration.errors }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="modules-section" class="form-section-card">
            <div class="form-section-header">
                <h5 style="color: white;"><i class="fas fa-puzzle-piece me-2" style="color: white;"></i>Modules</h5>
            </div>
            <div class="form-section-body">
                {{ formset.management_form }}
                {{ formset.non_form_errors }}
                <div id="module-forms-container">
                    {% for form in formset %}
                        <div class="module-form">
                            {{ form.id }}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ form.name.label_tag }}
                                        {{ form.name }}
                                        {{ form.name.errors }}
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="form-group">
                                        {{ form.module_duration.label_tag }}
                                        {{ form.module_duration }}
                                        {{ form.module_duration.errors }}
                                    </div>
                                </div>
                                <div class="col-md-1 d-flex align-items-center">
                                    {% if formset.can_delete %}
                                        {% if form.instance.pk %}<div style="display:none;">{{ form.DELETE }}</div>{% endif %}
                                        <button type="button" class="btn btn-danger remove-module-btn"><i class="fas fa-times"></i></button>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-check">
                                        {{ form.has_topics }}
                                        <label class="form-check-label" for="{{ form.has_topics.id_for_label }}">Has Topics</label>
                                    </div>
                                </div>
                            </div>
                            <div class="topics-section" style="display: {% if form.instance.has_topics %}block{% else %}none{% endif %};">
                                <h6>Topics</h6>
                                <div class="topic-forms-container">
                                    {{ form.topic_formset.management_form }}
                                    {% for topic_form in form.topic_formset %}
                                        <div class="topic-form">
                                            {{ topic_form.id }}
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        {{ topic_form.name.label_tag }}
                                                        {{ topic_form.name }}
                                                        {{ topic_form.name.errors }}
                                                    </div>
                                                </div>
                                                <div class="col-md-5">
                                                    <div class="form-group">
                                                        {{ topic_form.topic_duration.label_tag }}
                                                        {{ topic_form.topic_duration }}
                                                        {{ topic_form.topic_duration.errors }}
                                                    </div>
                                                </div>
                                                <div class="col-md-1 d-flex align-items-center">
                                                    {% if form.topic_formset.can_delete %}
                                                        {% if topic_form.instance.pk %}<div style="display:none;">{{ topic_form.DELETE }}</div>{% endif %}
                                                        <button type="button" class="btn btn-danger remove-topic-btn"><i class="fas fa-times"></i></button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <script type="text/template" class="empty-topic-form-template">
                                    <div class="topic-form">
                                        {{ form.topic_formset.empty_form.id }}
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{ form.topic_formset.empty_form.name.label_tag }}
                                                    {{ form.topic_formset.empty_form.name }}
                                                    {{ form.topic_formset.empty_form.name.errors }}
                                                </div>
                                            </div>
                                            <div class="col-md-5">
                                                <div class="form-group">
                                                    {{ form.topic_formset.empty_form.topic_duration.label_tag }}
                                                    {{ form.topic_formset.empty_form.topic_duration }}
                                                    {{ form.topic_formset.empty_form.topic_duration.errors }}
                                                </div>
                                            </div>
                                            <div class="col-md-1 d-flex align-items-center">
                                                <button type="button" class="btn btn-danger remove-topic-btn"><i class="fas fa-times"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </script>
                                <button type="button" class="btn btn-sm btn-secondary add-topic-btn">Add Topic</button>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <script type="text/template" id="empty-form-template">
                    <div class="module-form">
                        {{ formset.empty_form.id }}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ formset.empty_form.name.label_tag }}
                                    {{ formset.empty_form.name }}
                                    {{ formset.empty_form.name.errors }}
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="form-group">
                                    {{ formset.empty_form.module_duration.label_tag }}
                                    {{ formset.empty_form.module_duration }}
                                    {{ formset.empty_form.module_duration.errors }}
                                </div>
                            </div>
                            <div class="col-md-1 d-flex align-items-center">
                                <button type="button" class="btn btn-danger remove-module-btn"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-check">
                                    {{ formset.empty_form.has_topics }}
                                    <label class="form-check-label" for="{{ formset.empty_form.has_topics.id_for_label }}">Has Topics</label>
                                </div>
                            </div>
                        </div>
                        <div class="topics-section" style="display: none;">
                            <h6>Topics</h6>
                            <div class="topic-forms-container">
                                {{ formset.empty_form.topic_formset.management_form }}
                            </div>
                            <script type="text/template" class="empty-topic-form-template">
                                <div class="topic-form">
                                    {{ formset.empty_form.topic_formset.empty_form.id }}
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                {{ formset.empty_form.topic_formset.empty_form.name.label_tag }}
                                                {{ formset.empty_form.topic_formset.empty_form.name }}
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="form-group">
                                                {{ formset.empty_form.topic_formset.empty_form.topic_duration.label_tag }}
                                                {{ formset.empty_form.topic_formset.empty_form.topic_duration }}
                                            </div>
                                        </div>
                                        <div class="col-md-1 d-flex align-items-center">
                                            <button type="button" class="btn btn-danger remove-topic-btn"><i class="fas fa-times"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </script>
                            <button type="button" class="btn btn-sm btn-secondary add-topic-btn">Add Topic</button>
                        </div>
                    </div>
                </script>
                <button type="button" id="add-module-btn" class="btn btn-secondary">Add Module</button>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" id="save-button" class="btn btn-primary">Save</button>
            <a href="{% url 'coursedb:course_list' %}" class="btn btn-secondary">Cancel</a>
        </div>
        <div id="duration-error" class="alert alert-danger mt-2" style="display: none;"></div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const moduleFormsetPrefix = 'modules';
    const topicFormsetPrefix = 'topics';

    const moduleFormsContainer = document.getElementById('module-forms-container');
    const addModuleBtn = document.getElementById('add-module-btn');
    const emptyModuleFormTemplate = document.getElementById('empty-form-template');
    const categorySelect = document.getElementById('id_category');
    const codeInput = document.getElementById('id_code');
    const totalDurationInput = document.getElementById('id_total_duration');
    const saveButton = document.getElementById('save-button');
    const durationError = document.getElementById('duration-error');

    function updateAndValidate() {
        let courseTotal = parseInt(totalDurationInput.value, 10) || 0;
        let modulesTotal = 0;
        let errorMessages = [];

        document.querySelectorAll('.module-form').forEach((moduleForm) => {
            const deleteInput = moduleForm.querySelector(`input[name$="-DELETE"]`);
            if (deleteInput && deleteInput.checked) return;

            const moduleDurationInput = moduleForm.querySelector(`input[name$="-module_duration"]`);
            const moduleDuration = parseInt(moduleDurationInput.value, 10) || 0;
            modulesTotal += moduleDuration;

            const hasTopicsCheckbox = moduleForm.querySelector(`input[name$="-has_topics"]`);
            if (hasTopicsCheckbox && hasTopicsCheckbox.checked) {
                let topicsTotal = 0;
                moduleForm.querySelectorAll('.topic-form').forEach(topicForm => {
                    const topicDeleteInput = topicForm.querySelector(`input[name$="-DELETE"]`);
                    if (!topicDeleteInput || !topicDeleteInput.checked) {
                        const topicDurationInput = topicForm.querySelector(`input[name$="-topic_duration"]`);
                        topicsTotal += parseInt(topicDurationInput.value, 10) || 0;
                    }
                });

                if (moduleDuration !== topicsTotal) {
                    const moduleName = moduleForm.querySelector(`input[name$="-name"]`).value || `This module`;
                    errorMessages.push(`Topics in '${moduleName}' sum to ${topicsTotal}hrs, but module duration is ${moduleDuration}hrs.`);
                }
            }
        });

        if (courseTotal !== modulesTotal) {
            errorMessages.push(`All module durations sum to ${modulesTotal}hrs, but course duration is ${courseTotal}hrs.`);
        }

        durationError.innerHTML = errorMessages.join('<br>');
        durationError.style.display = errorMessages.length > 0 ? 'block' : 'none';
        saveButton.disabled = errorMessages.length > 0;
    }

    function escapeRegex(string) {
        return string.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
    }

    function addTopic(moduleForm) {
        if (!moduleForm) {
            console.error("addTopic was called without a module form.");
            return;
        }

        const topicFormsContainer = moduleForm.querySelector('.topic-forms-container');
        const emptyTopicTemplate = moduleForm.querySelector('.empty-topic-form-template');
        const totalFormsInput = moduleForm.querySelector(`input[name$="-${topicFormsetPrefix}-TOTAL_FORMS"]`);

        if (!topicFormsContainer || !emptyTopicTemplate || !totalFormsInput) {
            console.error("Module form is missing required elements for adding a topic.", {
                topicFormsContainer,
                emptyTopicTemplate,
                totalFormsInput
            });
            return;
        }

        const newIndex = parseInt(totalFormsInput.value);
        const formsetPrefix = totalFormsInput.name.replace('-TOTAL_FORMS', '');
        
        const prefixRegex = new RegExp(escapeRegex(formsetPrefix + '-__prefix__'), 'g');
        
        const newFormHtml = emptyTopicTemplate.innerHTML.replace(prefixRegex, `${formsetPrefix}-${newIndex}`);

        topicFormsContainer.insertAdjacentHTML('beforeend', newFormHtml);

        totalFormsInput.value = newIndex + 1;
        updateAndValidate();
    }

    addModuleBtn.addEventListener('click', () => {
        const totalFormsInput = document.querySelector(`#id_${moduleFormsetPrefix}-TOTAL_FORMS`);
        const newModuleIndex = parseInt(totalFormsInput.value);

        let newModuleHtml = emptyModuleFormTemplate.innerHTML;
        
        const modulePrefixRegex = new RegExp(escapeRegex(moduleFormsetPrefix + '-__prefix__'), 'g');
        newModuleHtml = newModuleHtml.replace(modulePrefixRegex, `${moduleFormsetPrefix}-${newModuleIndex}`);

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newModuleHtml.trim();
        const newModuleForm = tempDiv.firstElementChild;

        moduleFormsContainer.appendChild(newModuleForm);

        const totalTopicsInput = newModuleForm.querySelector(`input[name$="-${topicFormsetPrefix}-TOTAL_FORMS"]`);
        if (totalTopicsInput) {
            totalTopicsInput.value = 0;
        }

        totalFormsInput.value = newModuleIndex + 1;
        updateAndValidate();
    });

    document.body.addEventListener('click', e => {
        const target = e.target;
        const addTopicBtn = target.closest('.add-topic-btn');
        const removeTopicBtn = target.closest('.remove-topic-btn');
        const removeModuleBtn = target.closest('.remove-module-btn');

        if (addTopicBtn) {
            addTopic(addTopicBtn.closest('.module-form'));
        } else if (removeTopicBtn) {
            const topicForm = removeTopicBtn.closest('.topic-form');
            const deleteInput = topicForm.querySelector(`input[name$="-DELETE"]`);
            if (deleteInput) {
                deleteInput.checked = true;
                topicForm.style.display = 'none';
            } else {
                topicForm.remove();
            }
            updateAndValidate();
        } else if (removeModuleBtn) {
            const moduleForm = removeModuleBtn.closest('.module-form');
            const deleteInput = moduleForm.querySelector(`input[name$="-DELETE"]`);
            if (deleteInput) {
                deleteInput.checked = true;
                moduleForm.style.display = 'none';
            } else {
                moduleForm.remove();
            }
            updateAndValidate();
        }
    });

    document.body.addEventListener('change', e => {
        const hasTopicsCheckbox = e.target;
        if (hasTopicsCheckbox.matches('input[name$="-has_topics"]')) {
            const moduleForm = hasTopicsCheckbox.closest('.module-form');
            if (!moduleForm) return;

            const topicsSection = moduleForm.querySelector('.topics-section');
            const topicFormsContainer = moduleForm.querySelector('.topic-forms-container');

            if (hasTopicsCheckbox.checked) {
                topicsSection.style.display = 'block';
                // The automatic adding of a topic is removed to prevent race conditions.
                // User will need to click "Add Topic" manually.
            } else {
                topicsSection.style.display = 'none';
                topicFormsContainer.querySelectorAll('.topic-form').forEach(form => form.remove());
                const totalTopicsInput = moduleForm.querySelector(`input[name$="-topics-TOTAL_FORMS"]`);
                if (totalTopicsInput) totalTopicsInput.value = 0;
            }
            updateAndValidate();
        }
    });

    categorySelect.addEventListener('change', function() {
        const categoryId = this.value;
        if (categoryId) {
            const getCodeUrl = "{% url 'coursedb:get_next_course_code' %}";
            fetch(`${getCodeUrl}?category_id=${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.next_code) codeInput.value = data.next_code;
                })
                .catch(error => console.error('Error fetching course code:', error));
        }
    });

    document.body.addEventListener('input', e => {
        if (e.target.matches('input[name$="-module_duration"], input[name$="-topic_duration"], #id_total_duration')) {
            updateAndValidate();
        }
    });

    updateAndValidate();
});
</script>
{% endblock %}